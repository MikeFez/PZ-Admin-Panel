<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Zomboid Server Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .server-status {
            border-radius: 50px;
            padding: 5px 15px;
            font-weight: bold;
            color: white;
        }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-starting { background-color: #ffc107; color: #212529; }
        .status-stopping { background-color: #fd7e14; }
        .status-error { background-color: #dc3545; }

        .player-online { color: #28a745; }
        .player-offline { color: #6c757d; }

        .log-container {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 5px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .admin-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .btn-teleport {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
        }

        .btn-teleport:hover {
            background: linear-gradient(45deg, #FF5252, #26C6DA);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
        }

        .btn-purple:hover {
            background: linear-gradient(45deg, #5a6fd8, #6c4298);
            color: white;
        }
    </style>
</head>
<body>
    <div class="admin-panel">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h1 class="text-center text-white mb-4">
                        <i class="fas fa-gamepad"></i> Project Zomboid Server Admin Panel
                    </h1>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="row mb-3">
                        <div class="col-12">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}

            <div class="row">
                <!-- Server Control Panel -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-server"></i> Server Control</h4>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <span class="server-status status-{{ server_status.lower() }}">
                                    <i class="fas fa-circle"></i> {{ server_status }}
                                </span>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="startServer()"
                                        {% if server_status != 'Stopped' %}disabled{% endif %}>
                                    <i class="fas fa-play"></i> Start Server
                                </button>
                                <button class="btn btn-danger" onclick="stopServer()"
                                        {% if server_status == 'Stopped' %}disabled{% endif %}>
                                    <i class="fas fa-stop"></i> Stop Server
                                </button>
                                <button class="btn btn-warning" onclick="restartServer()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-redo"></i> Restart Server
                                </button>
                            </div>

                            <hr>

                            <h6><i class="fas fa-terminal"></i> Send Command</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="commandInput"
                                       placeholder="Enter server command..."
                                       {% if server_status != 'Running' %}disabled{% endif %}>
                                <button class="btn btn-primary" onclick="sendCommand()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Players Panel -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-users"></i> Members (<span id="memberCount">{{ users|length }}</span>)</h4>
                        </div>
                        <div class="card-body">
                            <div id="membersList">
                                {% if users %}
                                    <div class="list-group">
                                        {% for username, user_data in users.items() %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center member-item" data-username="{{ username }}">
                                                <span class="{% if user_data.online %}player-online{% else %}player-offline{% endif %}">
                                                    <i class="fas fa-{% if user_data.online %}circle text-success{% else %}circle text-muted{% endif %}"></i>
                                                    {{ username }}
                                                </span>
                                                <div class="text-end">
                                                    {% if user_data.online %}
                                                        <small class="text-success d-block">Online</small>
                                                    {% else %}
                                                        <small class="text-muted d-block">Offline</small>
                                                    {% endif %}
                                                    {% if user_data.get('last_seen') %}
                                                        <small class="text-muted">{{ user_data.last_seen[:16] if user_data.last_seen|length > 16 else user_data.last_seen }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No players have connected yet</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="saveWorldBtn" class="btn btn-info" onclick="sendCommand('save')"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-save"></i> Save World
                                </button>
                                <button id="announceBtn" class="btn btn-warning" onclick="sendCommand('servermsg &quot;Server restart in 5 minutes!&quot;')"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-exclamation-triangle"></i> Announce Restart
                                </button>
                                <button id="listPlayersBtn" class="btn btn-secondary" onclick="sendCommand('players')"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-list"></i> List Players
                                </button>
                                <a href="{{ url_for('mods') }}" class="btn btn-purple">
                                    <i class="fas fa-puzzle-piece"></i> Manage Mods
                                </a>
                                <a href="{{ url_for('locations') }}" class="btn btn-info">
                                    <i class="fas fa-map-marked-alt"></i> Manage Locations
                                </a>
                                <a href="{{ url_for('quit') }}" class="btn btn-outline-danger">
                                    <i class="fas fa-power-off"></i> Shutdown Panel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teleport Controls -->
            {% if players %}
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-exchange-alt"></i> Player to Player Teleport</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Teleport Player:</label>
                                    <select class="form-select" id="fromPlayer">
                                        {% for username in players %}
                                            <option value="{{ username }}">{{ username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">To Player:</label>
                                    <select class="form-select" id="toPlayer">
                                        {% for username in players %}
                                            <option value="{{ username }}">{{ username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-teleport" onclick="teleportPlayerToPlayer()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-magic"></i> Teleport
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-map-marker-alt"></i> Player to Location Teleport</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Player:</label>
                                    <select class="form-select" id="playerToLocation">
                                        {% for username in players %}
                                            <option value="{{ username }}">{{ username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Location:</label>
                                    <select class="form-select" id="targetLocation">
                                        {% for location_name in locations.keys() %}
                                            <option value="{{ location_name }}">{{ location_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-teleport" onclick="teleportPlayerToLocation()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-magic"></i> Teleport
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Server Log -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-file-alt"></i> Server Log</h4>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshLog()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="serverLog">
                                <div class="text-center text-muted">Loading server log...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lastLogUpdate = 0;

        // Auto-refresh status every 3 seconds for better real-time updates
        setInterval(refreshStatus, 3000);

        // Initial load
        refreshStatus();
        refreshLog();

        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update server status
                    updateServerStatus(data.server_status);

                    // Update members list
                    updateMembersList(data.users);

                    // Update log if there are new entries
                    if (data.log_lines && data.log_lines.length > lastLogUpdate) {
                        updateLog(data.log_lines);
                        lastLogUpdate = data.log_lines.length;
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function updateServerStatus(status) {
            const statusElement = document.querySelector('.server-status');
            statusElement.className = `server-status status-${status.toLowerCase()}`;
            statusElement.innerHTML = `<i class="fas fa-circle"></i> ${status}`;

            // Enable/disable buttons based on status
            const startBtn = document.querySelector('button[onclick="startServer()"]');
            const stopBtn = document.querySelector('button[onclick="stopServer()"]');
            const restartBtn = document.querySelector('button[onclick="restartServer()"]');
            const commandInput = document.getElementById('commandInput');
            const sendBtn = document.querySelector('button[onclick="sendCommand()"]');

            // Quick action buttons
            const saveWorldBtn = document.getElementById('saveWorldBtn');
            const announceBtn = document.getElementById('announceBtn');
            const listPlayersBtn = document.getElementById('listPlayersBtn');

            const isRunning = status === 'Running';
            const isStopped = status === 'Stopped';

            if (startBtn) startBtn.disabled = !isStopped;
            if (stopBtn) stopBtn.disabled = isStopped;
            if (restartBtn) restartBtn.disabled = !isRunning;
            if (commandInput) commandInput.disabled = !isRunning;
            if (sendBtn) sendBtn.disabled = !isRunning;

            // Quick action buttons
            if (saveWorldBtn) saveWorldBtn.disabled = !isRunning;
            if (announceBtn) announceBtn.disabled = !isRunning;
            if (listPlayersBtn) listPlayersBtn.disabled = !isRunning;

            // Update all teleport buttons
            document.querySelectorAll('.btn-teleport').forEach(btn => {
                btn.disabled = !isRunning;
            });
        }

        function updateLog(logLines) {
            const logContainer = document.getElementById('serverLog');
            logContainer.innerHTML = logLines.map(line => `<div>${escapeHtml(line)}</div>`).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function refreshLog() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.log_lines) {
                        updateLog(data.log_lines);
                    }
                })
                .catch(error => console.error('Error fetching log:', error));
        }

        function startServer() {
            fetch('/api/server/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert(data.error, 'danger');
                    } else {
                        showAlert(data.message, 'success');
                    }
                    setTimeout(refreshStatus, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to start server', 'danger');
                });
        }

        function stopServer() {
            if (confirm('Are you sure you want to stop the server?')) {
                fetch('/api/server/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showAlert(data.error, 'danger');
                        } else {
                            showAlert(data.message, 'success');
                        }
                        setTimeout(refreshStatus, 1000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Failed to stop server', 'danger');
                    });
            }
        }

        function restartServer() {
            if (confirm('Are you sure you want to restart the server?')) {
                stopServer();
                setTimeout(() => startServer(), 3000);
            }
        }

        function sendCommand(command = null) {
            const commandToSend = command || document.getElementById('commandInput').value.trim();
            if (!commandToSend) {
                showAlert('Please enter a command', 'warning');
                return;
            }

            fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: commandToSend })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    if (!command) document.getElementById('commandInput').value = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to send command', 'danger');
            });
        }

        function teleportPlayerToPlayer() {
            const fromPlayer = document.getElementById('fromPlayer').value;
            const toPlayer = document.getElementById('toPlayer').value;

            if (fromPlayer === toPlayer) {
                showAlert('Cannot teleport player to themselves', 'warning');
                return;
            }

            window.location.href = `/player_tp/${toPlayer}/${fromPlayer}`;
        }

        function teleportPlayerToLocation() {
            const player = document.getElementById('playerToLocation').value;
            const location = document.getElementById('targetLocation').value;

            window.location.href = `/location_tp/${location}/${player}`;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMembersList(users) {
            const membersList = document.getElementById('membersList');
            const memberCount = document.getElementById('memberCount');

            if (!users || Object.keys(users).length === 0) {
                membersList.innerHTML = '<p class="text-muted text-center">No players have connected yet</p>';
                memberCount.textContent = '0';
                return;
            }

            // Sort users: online first, then by username
            const sortedUsers = Object.entries(users).sort((a, b) => {
                const [nameA, dataA] = a;
                const [nameB, dataB] = b;

                // Online status priority
                if (dataA.online && !dataB.online) return -1;
                if (!dataA.online && dataB.online) return 1;

                // Then alphabetical
                return nameA.localeCompare(nameB);
            });

            let html = '<div class="list-group">';
            sortedUsers.forEach(([username, userData]) => {
                const isOnline = userData.online || false;
                const lastSeen = userData.last_seen || '';
                const displayTime = lastSeen.length > 16 ? lastSeen.substring(0, 16) : lastSeen;

                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center member-item" data-username="${username}">
                        <span class="${isOnline ? 'player-online' : 'player-offline'}">
                            <i class="fas fa-circle ${isOnline ? 'text-success' : 'text-muted'}"></i>
                            ${username}
                        </span>
                        <div class="text-end">
                            <small class="${isOnline ? 'text-success' : 'text-muted'} d-block">${isOnline ? 'Online' : 'Offline'}</small>
                            ${lastSeen ? `<small class="text-muted">${displayTime}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            membersList.innerHTML = html;
            memberCount.textContent = Object.keys(users).length;
        }

        // Allow Enter key to send commands
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCommand();
            }
        });
    </script>
</body>
</html>
