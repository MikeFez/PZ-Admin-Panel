<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Zomboid Server Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .server-status {
            border-radius: 50px;
            padding: 5px 15px;
            font-weight: bold;
            color: white;
        }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-starting { background-color: #ffc107; color: #212529; }
        .status-stopping { background-color: #fd7e14; }
        .status-error { background-color: #dc3545; }

        .player-online { color: #28a745; }
        .player-offline { color: #6c757d; }

        .log-container {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 5px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .admin-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .btn-teleport {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
        }

        .btn-teleport:hover {
            background: linear-gradient(45deg, #FF5252, #26C6DA);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
        }

        .btn-purple:hover {
            background: linear-gradient(45deg, #5a6fd8, #6c4298);
            color: white;
        }

        /* Ensure teleport sections display side by side */
        #teleportControls {
            margin-top: 2rem;
        }

        @media (min-width: 768px) {
            #teleportControls {
                display: flex !important;
                flex-wrap: wrap;
                gap: 1rem;
            }
            #teleportControls > .col-md-6 {
                flex: 1 1 calc(50% - 0.5rem);
                max-width: calc(50% - 0.5rem);
                margin-bottom: 1rem;
            }
        }

        /* Make sure cards don't overflow */
        .card {
            height: 100%;
            word-wrap: break-word;
        }

        /* Prevent form elements from making cards too wide */
        .form-select, .form-control {
            max-width: 100%;
            min-width: 0;
        }

        /* Ensure teleport card headers are aligned */
        #teleportControls .card-header h4 {
            font-size: 1.1rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="admin-panel">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h1 class="text-center text-white mb-4">
                        <i class="fas fa-gamepad"></i> Project Zomboid Server Admin Panel
                    </h1>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="row mb-3">
                        <div class="col-12">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}

            <div class="row">
                <!-- Server Control Panel -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-server"></i> Server Control</h4>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <span class="server-status status-{{ server_status.lower() }}">
                                    <i class="fas fa-circle"></i> {{ server_status }}
                                </span>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="startServer()"
                                        {% if server_status != 'Stopped' %}disabled{% endif %}>
                                    <i class="fas fa-play"></i> Start Server
                                </button>
                                <button class="btn btn-danger" onclick="stopServer()"
                                        {% if server_status == 'Stopped' %}disabled{% endif %}>
                                    <i class="fas fa-stop"></i> Stop Server
                                </button>
                                <button class="btn btn-warning" onclick="restartServer()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-redo"></i> Restart Server
                                </button>
                            </div>

                            <hr>

                            <h6><i class="fas fa-terminal"></i> Send Command</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="commandInput"
                                       placeholder="Enter server command..."
                                       {% if server_status != 'Running' %}disabled{% endif %}>
                                <button class="btn btn-primary" onclick="sendCommand()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Players Panel -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-users"></i> Members (<span id="memberCount">{{ users|length }}</span>)</h4>
                        </div>
                        <div class="card-body">
                            <div id="membersList">
                                {% if users %}
                                    <div class="list-group">
                                        {% for username, user_data in users.items() %}
                                            <div class="list-group-item member-item" data-username="{{ username }}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <span class="{% if user_data.online %}player-online{% else %}player-offline{% endif %}">
                                                            <i class="fas fa-{% if user_data.online %}circle text-success{% else %}circle text-muted{% endif %}"></i>
                                                            {{ username }}
                                                            {% if user_data.get('is_admin') %}
                                                                <i class="fas fa-crown text-warning ms-1" title="Admin"></i>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="text-end">
                                                        {% if user_data.online %}
                                                            <small class="text-success d-block">Online</small>
                                                        {% else %}
                                                            <small class="text-muted d-block">Offline</small>
                                                        {% endif %}
                                                        {% if user_data.get('last_seen') %}
                                                            <small class="text-muted">{{ user_data.last_seen[:16] if user_data.last_seen|length > 16 else user_data.last_seen }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="mt-2">
                                                    {% if user_data.get('allow_admin') and user_data.online and server_status == 'Running' %}
                                                        {% if user_data.get('is_admin') %}
                                                            <button class="btn btn-sm btn-danger" onclick="removeAdmin('{{ username }}')" title="Remove Admin">
                                                                <i class="fas fa-user-minus"></i> Remove Admin
                                                            </button>
                                                        {% else %}
                                                            <button class="btn btn-sm btn-success" onclick="grantAdmin('{{ username }}')" title="Grant Admin">
                                                                <i class="fas fa-user-plus"></i> Grant Admin
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No players have connected yet</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="saveWorldBtn" class="btn btn-info" onclick="sendCommand('save')"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-save"></i> Save World
                                </button>
                                <a href="{{ url_for('mods') }}" class="btn btn-purple">
                                    <i class="fas fa-puzzle-piece"></i> Manage Mods
                                </a>
                                <a href="{{ url_for('locations') }}" class="btn btn-info">
                                    <i class="fas fa-map-marked-alt"></i> Manage Locations
                                </a>
                                <a href="{{ url_for('quit') }}" class="btn btn-outline-danger">
                                    <i class="fas fa-power-off"></i> Shutdown Panel
                                </a>
                            </div>

                            <hr>

                            <h6><i class="fas fa-bullhorn"></i> Server Announcement</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="announcementInput"
                                       placeholder="Enter server announcement..."
                                       {% if server_status != 'Running' %}disabled{% endif %}>
                                <button class="btn btn-warning" onclick="sendAnnouncement()"
                                        {% if server_status != 'Running' %}disabled{% endif %}>
                                    <i class="fas fa-bullhorn"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teleport Controls -->
            <div class="row" id="teleportControls" {% if not players or server_status != 'Running' %}style="display: none;"{% endif %}>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-exchange-alt"></i> Player to Player Teleport</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Teleport Player:</label>
                                    <select class="form-select" id="fromPlayer" onchange="updateToPlayerOptions()">
                                        <option value="">-- Choose player --</option>
                                        {% if players %}
                                            {% for username in players %}
                                                <option value="{{ username }}">{{ username }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">To Player:</label>
                                    <select class="form-select" id="toPlayer" onchange="updateTeleportButtonStates()">
                                        <option value="">-- Choose player --</option>
                                        {% if players %}
                                            {% for username in players %}
                                                <option value="{{ username }}">{{ username }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-teleport" onclick="teleportPlayerToPlayer()" id="playerToPlayerBtn"
                                        {% if server_status != 'Running' or (players and players|length < 2) or not players %}disabled{% endif %}>
                                    <i class="fas fa-magic"></i> Teleport
                                </button>
                                <small class="text-muted mt-2" id="playerToPlayerMessage" style="display: none;"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h4><i class="fas fa-map-marker-alt"></i> Player to Location Teleport</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Player:</label>
                                    <select class="form-select" id="playerToLocation" onchange="updateTeleportButtonStates()">
                                        <option value="">-- Choose player --</option>
                                        {% if players %}
                                            {% for username in players %}
                                                <option value="{{ username }}">{{ username }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Location:</label>
                                    <select class="form-select" id="targetLocation" onchange="updateTeleportButtonStates()">
                                        <option value="">-- Choose location --</option>
                                        {% if locations %}
                                            {% for location_name in locations.keys() %}
                                                <option value="{{ location_name }}">{{ location_name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-teleport" onclick="teleportPlayerToLocation()" id="playerToLocationBtn"
                                        {% if server_status != 'Running' or (players and players|length < 1) or not players %}disabled{% endif %}>
                                    <i class="fas fa-magic"></i> Teleport
                                </button>
                                <small class="text-muted mt-2" id="playerToLocationMessage" style="display: none;"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Server Log -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4><i class="fas fa-file-alt"></i> Server Log</h4>
                            <button class="btn btn-sm btn-outline-light" onclick="refreshLog()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="serverLog">
                                <div class="text-center text-muted">Loading server log...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let lastLogUpdate = 0;
        let currentServerStatus = '{{ server_status }}'; // Track current server status
        let lastOnlinePlayersHash = ''; // Track changes to online players

        // Auto-refresh status every 1 second for better real-time updates
        setInterval(refreshStatus, 1000);

        // Initial load
        refreshStatus();
        refreshLog();

        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update server status
                    updateServerStatus(data.server_status);

                    // Update members list
                    updateMembersList(data.users);

                    // Update log - always update during server startup/changes
                    if (data.log_lines) {
                        // Always update log if server status is Starting, Stopping, or if we have significantly different log count
                        const shouldUpdateLog = currentServerStatus === 'Starting' ||
                                              currentServerStatus === 'Stopping' ||
                                              data.log_lines.length !== lastLogUpdate ||
                                              Math.abs(data.log_lines.length - lastLogUpdate) > 1; // Handle log resets

                        if (shouldUpdateLog) {
                            updateLog(data.log_lines);
                            lastLogUpdate = data.log_lines.length;
                        }
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function updateServerStatus(status) {
            const statusChanged = currentServerStatus !== status;
            currentServerStatus = status; // Update global status variable

            const statusElement = document.querySelector('.server-status');
            statusElement.className = `server-status status-${status.toLowerCase()}`;
            statusElement.innerHTML = `<i class="fas fa-circle"></i> ${status}`;

            // Enable/disable buttons based on status
            const startBtn = document.querySelector('button[onclick="startServer()"]');
            const stopBtn = document.querySelector('button[onclick="stopServer()"]');
            const restartBtn = document.querySelector('button[onclick="restartServer()"]');
            const commandInput = document.getElementById('commandInput');
            const sendBtn = document.querySelector('button[onclick="sendCommand()"]');

            // Quick action buttons
            const saveWorldBtn = document.getElementById('saveWorldBtn');
            const listPlayersBtn = document.getElementById('listPlayersBtn');
            const announcementInput = document.getElementById('announcementInput');
            const announceBtn = document.querySelector('button[onclick="sendAnnouncement()"]');

            const isRunning = status === 'Running';
            const isStopped = status === 'Stopped';

            if (startBtn) startBtn.disabled = !isStopped;
            if (stopBtn) stopBtn.disabled = isStopped;
            if (restartBtn) restartBtn.disabled = !isRunning;
            if (commandInput) commandInput.disabled = !isRunning;
            if (sendBtn) sendBtn.disabled = !isRunning;

            // Quick action buttons
            if (saveWorldBtn) saveWorldBtn.disabled = !isRunning;
            if (listPlayersBtn) listPlayersBtn.disabled = !isRunning;
            if (announcementInput) announcementInput.disabled = !isRunning;
            if (announceBtn) announceBtn.disabled = !isRunning;

            // Only update teleport controls if server status changed
            if (statusChanged) {
                // Update teleport sections visibility based on server status
                const onlinePlayers = Object.entries(window.cachedUsers || {})
                    .filter(([username, userData]) => userData.online)
                    .map(([username]) => username);
                updateTeleportSections(onlinePlayers);
            }
        }

        function updateLog(logLines) {
            const logContainer = document.getElementById('serverLog');
            logContainer.innerHTML = logLines.map(line => `<div>${escapeHtml(line)}</div>`).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function refreshLog() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.log_lines) {
                        updateLog(data.log_lines);
                    }
                })
                .catch(error => console.error('Error fetching log:', error));
        }

        function startServer() {
            // Reset log tracking to ensure we see startup logs
            lastLogUpdate = 0;

            fetch('/api/server/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert(data.error, 'danger');
                    } else {
                        showAlert(data.message, 'success');
                    }
                    // Immediately refresh to start showing logs
                    refreshStatus();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Failed to start server', 'danger');
                });
        }

        function stopServer() {
            if (confirm('Are you sure you want to stop the server?')) {
                fetch('/api/server/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showAlert(data.error, 'danger');
                        } else {
                            showAlert(data.message, 'success');
                        }
                        setTimeout(refreshStatus, 1000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Failed to stop server', 'danger');
                    });
            }
        }

        function restartServer() {
            if (confirm('Are you sure you want to restart the server?')) {
                stopServer();
                setTimeout(() => startServer(), 3000);
            }
        }

        function sendCommand(command = null) {
            const commandToSend = command || document.getElementById('commandInput').value.trim();
            if (!commandToSend) {
                showAlert('Please enter a command', 'warning');
                return;
            }

            fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: commandToSend })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    if (!command) document.getElementById('commandInput').value = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to send command', 'danger');
            });
        }

        function sendAnnouncement() {
            const announcementText = document.getElementById('announcementInput').value.trim();
            if (!announcementText) {
                showAlert('Please enter an announcement message', 'warning');
                return;
            }

            // Escape quotes and format as servermsg command
            const escapedText = announcementText.replace(/"/g, '\\"');
            const command = `servermsg "${escapedText}"`;

            fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert('Announcement sent to all players', 'success');
                    document.getElementById('announcementInput').value = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to send announcement', 'danger');
            });
        }

        function teleportPlayerToPlayer() {
            const fromPlayer = document.getElementById('fromPlayer').value;
            const toPlayer = document.getElementById('toPlayer').value;

            if (!fromPlayer || !toPlayer) {
                showAlert('Please select both players for teleportation', 'warning');
                return;
            }

            if (fromPlayer === toPlayer) {
                showAlert('Cannot teleport player to themselves', 'warning');
                return;
            }

            window.location.href = `/player_tp/${toPlayer}/${fromPlayer}`;
        }

        function teleportPlayerToLocation() {
            const player = document.getElementById('playerToLocation').value;
            const location = document.getElementById('targetLocation').value;

            if (!player || !location) {
                showAlert('Please select both player and location for teleportation', 'warning');
                return;
            }

            window.location.href = `/location_tp/${location}/${player}`;
        }

        function updateToPlayerOptions() {
            const fromPlayerSelect = document.getElementById('fromPlayer');
            const toPlayerSelect = document.getElementById('toPlayer');

            // Check if elements exist
            if (!fromPlayerSelect || !toPlayerSelect) {
                return;
            }

            const selectedFromPlayer = fromPlayerSelect.value;

            // Store current selection in toPlayer
            const currentToPlayer = toPlayerSelect.value;

            // Clear toPlayer options
            toPlayerSelect.innerHTML = '<option value="">-- Choose player --</option>';

            // Get all online players from the fromPlayer dropdown
            const allPlayers = [];
            for (let i = 1; i < fromPlayerSelect.options.length; i++) { // Skip first "Choose player" option
                allPlayers.push(fromPlayerSelect.options[i].value);
            }

            // Add all options except the selected fromPlayer
            allPlayers.forEach(player => {
                if (player !== selectedFromPlayer) {
                    const option = new Option(player, player);
                    if (player === currentToPlayer && player !== selectedFromPlayer) {
                        option.selected = true;
                    }
                    toPlayerSelect.appendChild(option);
                }
            });

            // Don't call updateTeleportButtonStates here - let updatePlayerDropdowns handle it
            // Manual dropdown changes will still call updateTeleportButtonStates via onchange events
        }        function updateTeleportButtonStates() {
            // Check if teleport elements exist (they might be hidden)
            const fromPlayerSelect = document.getElementById('fromPlayer');
            const toPlayerSelect = document.getElementById('toPlayer');
            const playerToLocationSelect = document.getElementById('playerToLocation');
            const targetLocationSelect = document.getElementById('targetLocation');

            // If any key element is missing, skip the update
            if (!fromPlayerSelect || !toPlayerSelect || !playerToLocationSelect || !targetLocationSelect) {
                return;
            }

            const fromPlayer = fromPlayerSelect.value;
            const toPlayer = toPlayerSelect.value;
            const playerToLocation = playerToLocationSelect.value;
            const targetLocation = targetLocationSelect.value;
            const serverRunning = currentServerStatus === 'Running';

            // Get current online player count from cached users data (more reliable than dropdown count)
            const onlinePlayers = window.cachedUsers ?
                Object.entries(window.cachedUsers).filter(([username, userData]) => userData.online) : [];
            const onlinePlayerCount = onlinePlayers.length;
            const locationCount = targetLocationSelect.options.length - 1; // -1 for default option

            // Player to player button and message
            const playerToPlayerBtn = document.getElementById('playerToPlayerBtn');
            const playerToPlayerMessage = document.getElementById('playerToPlayerMessage');
            if (playerToPlayerBtn && playerToPlayerMessage) {
                const canTeleportPlayers = serverRunning && fromPlayer && toPlayer && fromPlayer !== toPlayer && onlinePlayerCount >= 2;
                playerToPlayerBtn.disabled = !canTeleportPlayers;

                // Show message if not enough players or server not running
                if (!serverRunning) {
                    playerToPlayerMessage.style.display = 'block';
                    playerToPlayerMessage.classList.add('d-block');
                    playerToPlayerMessage.textContent = 'Server must be running';
                } else if (onlinePlayerCount < 2) {
                    playerToPlayerMessage.style.display = 'block';
                    playerToPlayerMessage.classList.add('d-block');
                    playerToPlayerMessage.textContent = 'Need at least 2 online players';
                } else {
                    playerToPlayerMessage.style.display = 'none';
                    playerToPlayerMessage.classList.remove('d-block');
                }
            }

            // Player to location button and message
            const playerToLocationBtn = document.getElementById('playerToLocationBtn');
            const playerToLocationMessage = document.getElementById('playerToLocationMessage');
            if (playerToLocationBtn && playerToLocationMessage) {
                const canTeleportToLocation = serverRunning && playerToLocation && targetLocation && onlinePlayerCount >= 1 && locationCount >= 1;
                playerToLocationBtn.disabled = !canTeleportToLocation;

                // Show message based on what's missing
                if (!serverRunning) {
                    playerToLocationMessage.style.display = 'block';
                    playerToLocationMessage.classList.add('d-block');
                    playerToLocationMessage.textContent = 'Server must be running';
                } else if (onlinePlayerCount < 1) {
                    playerToLocationMessage.style.display = 'block';
                    playerToLocationMessage.classList.add('d-block');
                    playerToLocationMessage.textContent = 'No online players';
                } else if (locationCount < 1) {
                    playerToLocationMessage.style.display = 'block';
                    playerToLocationMessage.classList.add('d-block');
                    playerToLocationMessage.textContent = 'No locations available';
                } else if (!playerToLocation) {
                    playerToLocationMessage.style.display = 'block';
                    playerToLocationMessage.classList.add('d-block');
                    playerToLocationMessage.textContent = 'Please select a player';
                } else if (!targetLocation) {
                    playerToLocationMessage.style.display = 'block';
                    playerToLocationMessage.classList.add('d-block');
                    playerToLocationMessage.textContent = 'Please select a location';
                } else {
                    playerToLocationMessage.style.display = 'none';
                    playerToLocationMessage.classList.remove('d-block');
                }
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateMembersList(users) {
            // Cache users data for other functions to use
            window.cachedUsers = users;

            const membersList = document.getElementById('membersList');
            const memberCount = document.getElementById('memberCount');

            if (!users || Object.keys(users).length === 0) {
                membersList.innerHTML = '<p class="text-muted text-center">No players have connected yet</p>';
                memberCount.textContent = '0';

                // Check if online players changed
                const newOnlinePlayersHash = '';
                if (lastOnlinePlayersHash !== newOnlinePlayersHash) {
                    lastOnlinePlayersHash = newOnlinePlayersHash;
                    updateTeleportSections([]);
                }
                return;
            }

            // Get online players
            const onlinePlayers = Object.entries(users)
                .filter(([username, userData]) => userData.online)
                .map(([username]) => username);

            // Create a hash of online players to detect changes
            const newOnlinePlayersHash = onlinePlayers.sort().join(',');
            const onlinePlayersChanged = lastOnlinePlayersHash !== newOnlinePlayersHash;

            if (onlinePlayersChanged) {
                lastOnlinePlayersHash = newOnlinePlayersHash;
            }

            // Sort users: online first, then by username
            const sortedUsers = Object.entries(users).sort((a, b) => {
                const [nameA, dataA] = a;
                const [nameB, dataB] = b;

                // Online status priority
                if (dataA.online && !dataB.online) return -1;
                if (!dataA.online && dataB.online) return 1;

                // Then alphabetical
                return nameA.localeCompare(nameB);
            });

            let html = '<div class="list-group">';
            sortedUsers.forEach(([username, userData]) => {
                const isOnline = userData.online || false;
                const lastSeen = userData.last_seen || '';
                const displayTime = lastSeen.length > 16 ? lastSeen.substring(0, 16) : lastSeen;
                const allowAdmin = userData.allow_admin || false;
                const isAdmin = userData.is_admin || false;

                html += `
                    <div class="list-group-item member-item" data-username="${username}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="${isOnline ? 'player-online' : 'player-offline'}">
                                    <i class="fas fa-circle ${isOnline ? 'text-success' : 'text-muted'}"></i>
                                    ${username}
                                    ${isAdmin ? '<i class="fas fa-crown text-warning ms-1" title="Admin"></i>' : ''}
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="${isOnline ? 'text-success' : 'text-muted'} d-block">${isOnline ? 'Online' : 'Offline'}</small>
                                ${lastSeen ? `<small class="text-muted">${displayTime}</small>` : ''}
                            </div>
                        </div>
                        ${allowAdmin && isOnline && currentServerStatus === 'Running' ? `
                        <div class="mt-2">
                            ${isAdmin ?
                                `<button class="btn btn-sm btn-danger" onclick="removeAdmin('${username}')" title="Remove Admin">
                                    <i class="fas fa-user-minus"></i> Remove Admin
                                </button>` :
                                `<button class="btn btn-sm btn-success" onclick="grantAdmin('${username}')" title="Grant Admin">
                                    <i class="fas fa-user-plus"></i> Grant Admin
                                </button>`
                            }
                        </div>` : ''}
                    </div>
                `;
            });
            html += '</div>';

            membersList.innerHTML = html;
            memberCount.textContent = Object.keys(users).length;

            // Only update teleport sections if online players changed
            if (onlinePlayersChanged) {
                updateTeleportSections(onlinePlayers);
            }
        }

        function updateTeleportSections(onlinePlayers) {
            // Find the teleport controls container
            const teleportContainer = document.getElementById('teleportControls');

            if (teleportContainer) {
                // Show teleport controls only if server is running AND there are online players
                // Also check if we have at least one location for Player to Location teleport
                const hasLocations = document.getElementById('targetLocation') &&
                                   document.getElementById('targetLocation').options.length > 1; // -1 for default option

                if (onlinePlayers.length > 0 && currentServerStatus === 'Running') {
                    teleportContainer.style.display = 'block';
                } else {
                    teleportContainer.style.display = 'none';
                    return;
                }
            }

            // Update dropdowns
            updatePlayerDropdowns(onlinePlayers);
        }

        function updatePlayerDropdowns(onlinePlayers) {
            const fromPlayerSelect = document.getElementById('fromPlayer');
            const toPlayerSelect = document.getElementById('toPlayer');
            const playerToLocationSelect = document.getElementById('playerToLocation');

            if (!fromPlayerSelect || !toPlayerSelect || !playerToLocationSelect) return;

            // Store current selections
            const currentFromPlayer = fromPlayerSelect.value;
            const currentToPlayer = toPlayerSelect.value;
            const currentPlayerToLocation = playerToLocationSelect.value;

            // Update fromPlayer dropdown
            fromPlayerSelect.innerHTML = '<option value="">-- Choose player --</option>';
            onlinePlayers.forEach(player => {
                const option = new Option(player, player);
                if (player === currentFromPlayer) option.selected = true;
                fromPlayerSelect.appendChild(option);
            });

            // Update playerToLocation dropdown
            playerToLocationSelect.innerHTML = '<option value="">-- Choose player --</option>';
            onlinePlayers.forEach(player => {
                const option = new Option(player, player);
                if (player === currentPlayerToLocation) option.selected = true;
                playerToLocationSelect.appendChild(option);
            });

            // Update toPlayer dropdown (excluding selected fromPlayer) - call this AFTER fromPlayer is populated
            updateToPlayerOptions();

            // Update button states - call this AFTER all dropdowns are updated
            updateTeleportButtonStates();
        }

        // Admin management functions
        function grantAdmin(username) {
            if (currentServerStatus !== 'Running') {
                showAlert('Server must be running to manage admin permissions', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to grant admin permissions to ${username}?`)) {
                return;
            }

            fetch('/api/players/grant-admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    // Refresh the status to update the members list
                    refreshStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to grant admin permissions', 'danger');
            });
        }

        function removeAdmin(username) {
            if (currentServerStatus !== 'Running') {
                showAlert('Server must be running to manage admin permissions', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to remove admin permissions from ${username}?`)) {
                return;
            }

            fetch('/api/players/remove-admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'danger');
                } else {
                    showAlert(data.message, 'success');
                    // Refresh the status to update the members list
                    refreshStatus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to remove admin permissions', 'danger');
            });
        }

        // Allow Enter key to send commands
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCommand();
            }
        });

        // Allow Enter key to send announcements
        document.getElementById('announcementInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAnnouncement();
            }
        });
    </script>
</body>
</html>
